<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NewAge - Focus Lockdown</title>
    <style>
        body, html {
            margin: 0; padding: 0; 
            width: 100%; height: 100%;
            background-color: #000;
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }
        #game-wrapper {
            width: 1280px; height: 720px;
            position: absolute;
            transform-origin: 0 0;
            will-change: transform;
            background: #000;
            transition: transform 0.2s ease-out;
        }
        #ruffle-container, ruffle-player {
            width: 1280px !important; height: 720px !important;
            display: block;
        }
        ruffle-player::part(splash) { display: none !important; }
        #kbdBtn {
            position: fixed; bottom: 30px; right: 30px;
            z-index: 9999; width: 65px; height: 65px;
            border-radius: 50%;
            background: rgba(40, 40, 40, 0.9);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.4);
            font-size: 26px;
            display: flex; align-items: center; justify-content: center;
            touch-action: none; 
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }
        #kbdBtn.active { background: #27ae60; border-color: #fff; box-shadow: 0 0 20px #27ae60; }
    </style>
</head>
<body>

    <div id="game-wrapper">
        <div id="ruffle-container"></div>
    </div>
    
    <button id="kbdBtn" tabindex="-1">⌨️</button>

    <script src="./ruffle/ruffle.js"></script>

    <script>
        // --- РЕЄСТРАЦІЯ СИСТЕМИ КЕШУВАННЯ ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('SW: Віртуальна папка активована'))
                .catch(err => console.log('SW: Помилка системи кешу', err));
        }

        const wrapper = document.getElementById('game-wrapper');
        const btn = document.getElementById('kbdBtn');
        let scale = 1, baseScale = 1, tx = 0, ty = 0, isKeyboardActive = false;

        function apply() {
            const viewW = window.innerWidth;
            const viewH = window.innerHeight;
            const gameW = 1280 * scale;
            const gameH = 720 * scale;

            let fTx = (gameW <= viewW) ? (viewW - gameW) / 2 : Math.max(viewW - gameW, Math.min(tx, 0));
            let fTy = isKeyboardActive ? (viewH - gameH) : 
                     ((gameH <= viewH) ? (viewH - gameH) / 2 : Math.max(viewH - gameH, Math.min(ty, 0)));
            
            wrapper.style.transform = `translate3d(${fTx}px, ${fTy}px, 0) scale(${scale})`;
        }

        function initScale() {
            if (!isKeyboardActive) {
                baseScale = Math.min(window.innerWidth / 1280, window.innerHeight / 720);
                scale = baseScale;
                tx = (window.innerWidth - 1280 * scale) / 2;
                ty = (window.innerHeight - 720 * scale) / 2;
            }
            apply();
        }

        // --- ЛОГІКА ЗУМУ ---
        let midX = 0, midY = 0, startDist = 0, startScale = 1, startTx = 0, startTy = 0;
        
        window.addEventListener('touchstart', (e) => {
            if (e.target.id === 'kbdBtn') return;
            const player = document.querySelector("ruffle-player");
            if (!isKeyboardActive && player) player.tabIndex = -1;

            if (e.touches.length >= 2) {
                e.preventDefault();
                if (document.activeElement) document.activeElement.blur();
                startDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                startScale = scale; startTx = tx; startTy = ty;
                midX = (e.touches[0].pageX + e.touches[1].pageX) / 2;
                midY = (e.touches[0].pageY + e.touches[1].pageY) / 2;
            }
        }, {passive: false, capture: true});

        window.addEventListener('touchmove', (e) => {
            if (e.touches.length >= 2 && startDist > 0) {
                e.preventDefault();
                const curDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                const newScale = Math.max(baseScale, Math.min(startScale * (curDist / startDist), baseScale * 5));
                const ratio = newScale / startScale;
                tx = midX - (midX - startTx) * ratio;
                ty = midY - (midY - startTy) * ratio;
                scale = newScale;
                apply();
            }
        }, {passive: false});

        // --- КЕРУВАННЯ КНОПКОЮ ---
        let bX=0, bY=0, bStartX, bStartY, bInitX, bInitY, isDraggingBtn=false, isButtonTouched=false;

        btn.addEventListener("touchstart", (e) => {
            e.preventDefault(); 
            e.stopImmediatePropagation();
            isButtonTouched = true;
            isDraggingBtn = false;
            const m = new WebKitCSSMatrix(window.getComputedStyle(btn).transform);
            bInitX = e.touches[0].clientX - m.m41;
            bInitY = e.touches[0].clientY - m.m42;
            bStartX = e.touches[0].clientX;
            bStartY = e.touches[0].clientY;
        }, {passive: false});

        window.addEventListener("touchmove", (e) => {
            if (!isButtonTouched) return;
            const cx = e.touches[0].clientX;
            const cy = e.touches[0].clientY;
            if (Math.hypot(cx - bStartX, cy - bStartY) > 10) isDraggingBtn = true;
            if (isDraggingBtn) {
                bX = cx - bInitX; bY = cy - bInitY;
                btn.style.transform = `translate3d(${bX}px, ${bY}px, 0)`;
            }
        }, {passive: false});

        btn.addEventListener("touchend", (e) => {
            if (isButtonTouched) {
                if (!isDraggingBtn) {
                    isKeyboardActive = !isKeyboardActive;
                    btn.classList.toggle('active', isKeyboardActive);
                    const player = document.querySelector("ruffle-player");
                    if (isKeyboardActive) {
                        scale = baseScale * 1.2;
                        if (player) { player.tabIndex = 0; player.focus(); }
                    } else {
                        scale = baseScale;
                        if (player) { player.tabIndex = -1; player.blur(); }
                        window.focus();
                    }
                    if (window.AndroidControl) window.AndroidControl.toggleKeyboard(isKeyboardActive);
                }
                isButtonTouched = isDraggingBtn = false;
                apply();
            }
        });

        window.addEventListener('focusin', (e) => {
            if (!isKeyboardActive && e.target.tagName !== 'BUTTON') {
                e.stopImmediatePropagation();
                e.target.blur();
                window.focus();
            }
        }, true);

        window.RufflePlayer = window.RufflePlayer || {};
        window.RufflePlayer.config = { "splashScreen": false, "quality": "low", "preferredRenderer": "webgl", "allowNetworking": "all" };

        window.addEventListener("DOMContentLoaded", () => {
            const player = window.RufflePlayer.newest().createPlayer();
            player.tabIndex = -1;
            document.getElementById("ruffle-container").appendChild(player);
            player.load({ url: "game.swf", allowScriptAccess: true });
            setTimeout(initScale, 150);
        });

        window.addEventListener('resize', apply);
    </script>
</body>
</html>